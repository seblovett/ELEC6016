%  cpu.tex
%  Document created by seblovett on octopus
%  Date created: Thu 03 Apr 2014 12:56:02 BST
%  <+Last Edited: Fri 04 Apr 2014 10:40:46 BST by hl13g10 on octopus +>

%\section{Processor}

%The whole processor is pulled together in two encapsulating modules. 
%The datapath module links the registers and ALU and implements the data multiplexors, program counter and accumulator.
%The top level CPU module links the program ROM, controller and datapath. 

\section{Datapath}\label{sect:datapath}
\subsection{Testbench}
%\todo[inline]{Explain testbench}
The testbench conducts the following tests:
\begin{enumerate}
\item Program counter increment and write enable
\item Immidate loading into accumulator
\item Addition with an immediate
\item Write back to register
\item Read from register
\item Store switches to registers
\item Read switches from register
\item Program counter jump to accumulator value
\end{enumerate}

These operations are verified by viewing the LED output (the accumulator) and the program counter.
Assertions are used to check the outputs and keep an error count. 
This testbench is to check the internal connections of the datapath, and also the implementation of the extra registers.
Figure \ref{fig:datapathsim} shows the waveform of the simulation. 
The error count remains zero through out showing no errors exist in the datapath.
%\subsection{Simulation}
%\todo[inline]{Simulation Results}

\begin{figure}
\includegraphics[height=\textheight]{Figures/datapathsim.eps}
\caption{Datapath simulation waveform}
\label{fig:datapathsim}
\end{figure}

\subsection{Synthesis}
\todo[inline]{Synthesis}

\section{CPU}
\subsection{Testbench}
%\todo[inline]{Describe testbench}

The testbench has two main parts; a task to commence the handshaking protocols, and a function to calculated the expected result. 
The handshaking task also contains assertions to verify the output. 
The function contains the constants and calculates the transform, with correct rounding.
The task can be seen in listing \ref{lstcputask} and the function is shown in listing \ref{lstcpufunction}.
These are used by a loop to test a random set of inputs. 
A few basic tests are also done with simple data. 

\lstinputlisting[breaklines=true,firstline=31, lastline=63,caption={Verification task to conduct the handshaking protocols. Assertions are used in this task to verify the output.},frame=single,label=lstcputask]{../Implementation/cpu_stim.sv}
\lstinputlisting[language=verilog, breaklines=true,firstline=65, lastline=81,caption={Function used to calculate the expected output of the affine transform.},frame=single,label=lstcpufunction]{../Implementation/cpu_stim.sv}




\subsection{Simulation Results}
%\todo[inline]{Full System Test}

Figure \ref{fig:cpusim} shows the output waveform of the test. 
Registers 0-5 contain the constants used. 
Registers 6 and 7 are used to store the initial $x_1$ and $y_1$ vector. 
Registers 9 and 10 are used to store the result and register 8 is used as a temporary register. 
The global error counter is shown at the top of the waveform, indicating that the whole system passes the test. 
Each iteration consists of a function call to calculate the expected outcome, and a task call to input the data. 
This process is then looped to test different datasets. 

\begin{figure}
\includegraphics[height=\textheight]{Figures/cpusim.eps}
\caption{CPU simulation waveform}
\label{fig:cpusim}
\end{figure}

\subsection{Synthesis}
\todo[inline]{Full system synthesis}


